# ディレクトリ構成

## 全体

```tree
tvine/
├── Cargo.toml              # Cargo workspace root
├── src-tauri/               # Tauri エントリポイント（binary crate）
├── crates/
│   ├── kernel/              # ドメインモデル、trait 定義
│   ├── adapter/             # 外部接続の実装
│   ├── data/                # データの生成・読み書き
│   ├── registry/            # trait と実装の紐づけ（DI）
│   ├── cli/                 # 開発用 CLI（動作確認用、リリースには含まない）
│   └── shared/              # 共有型・ユーティリティ
├── src/                     # React フロントエンド
├── public/
├── docs/
├── package.json
├── tsconfig.json
└── vite.config.ts
```

## アーキテクチャ

rusty-book-manager のオニオンアーキテクチャを参考にする。
依存の方向は外→内（adapter → kernel）。kernel は外側を知らない。

```text
src-tauri → registry → adapter → kernel
cli      → registry → adapter → kernel
                     → data    → kernel
                                 shared
```

## クレート

### src-tauri

Tauri の binary crate。フロントエンドとの境界。

- Tauri コマンド定義（フロントエンドからの IPC）
- アプリの初期化（registry を使って依存を組み立て）
- Tauri イベントの発行（ステータス変更等をフロントエンドに通知）

### kernel

ドメインモデルと trait 定義。外部に依存しない。

- セッション、スロット、ステータスのモデル定義
- リポジトリ等の trait 定義（SessionRepository, SlotRepository 等）
- ビジネスロジック（バリデーション、排他スロットの判定等）

### adapter

kernel の trait を実装する外部接続層。

- git 操作（worktree add/remove, diff, branch list）
- PTY 管理（Claude Code、ターミナルのプロセス管理）
- Unix socket リスナー（ステータス受信）

### data

ファイル構造の生成と読み書き。

- **ユーザー固有データ**: セッションディレクトリの生成、session.json / status.json / slots.json の読み書き
- **アプリ固有データ**: Plugin ファイルの生成・更新（plugin.json, hooks.json, notify.sh）
- プロジェクト識別子の生成（パスベース）

### registry

trait と実装の紐づけ + ハンドラー。

- 本番用の組み立て（adapter / data の実装を kernel の trait に紐づけ）
- テスト時は mock に差し替えられる構造を提供
- 各クレートのテストコードに本番/mock の判断を散らばらせない
- ユースケースを実行するハンドラーを提供する。src-tauri と cli の両方がこのハンドラーを呼ぶ

### shared

複数クレートで共有する型やユーティリティ。

## フロントエンド（src/）

Bulletproof React を参考にした feature ベースの構成。

```tree
src/
├── app/                    # エントリポイント、プロバイダ、ルーティング
├── features/               # 機能ごとに分離（feature 間の相互参照は禁止）
│   ├── sessions/           # セッション一覧・作成・削除・情報
│   ├── slots/              # スロット作成・編集
│   ├── terminal/           # Claude 端末・汎用ターミナル
│   ├── diff/               # 差分表示（Changes パネル）
│   └── status/             # ステータス管理
├── components/             # 共有コンポーネント（モーダル枠、バッジ等）
├── hooks/                  # 共有 hooks
├── stores/                 # グローバル状態管理
├── lib/                    # 外部ライブラリのラッパー（xterm.js, Tauri API 等）
├── utils/                  # ユーティリティ
├── types/                  # 共有型
├── config/                 # 設定
└── assets/                 # 静的ファイル
```

### 設計方針

- 機能は features/ に閉じ込め、feature 間の相互参照を禁止する
- 共有するものは components/, hooks/ 等に上げる
- xterm.js は Claude 端末と汎用ターミナルの2箇所で使うため lib/ にラッパーを置く
- Tauri コマンド呼び出し（@tauri-apps/api）も lib/ にまとめる
