# ステータス管理

## 概要

各セッションの Claude Code が今どの状態にあるかを検出し、セッション一覧に表示する。
ユーザーはステータスを見てどのセッションに注意を向けるべきか判断する。

## ステータスの種類

| ステータス | 意味 |
| --- | --- |
| Busy | Claude Code が作業している |
| Waiting | ユーザーの確認・承認を待っている（y/n 等） |
| Idle | 新しい入力を受け付けられる状態 |

## 検出方法

Claude Code の hooks 機能を使って検出する。JSONL は MVP では使わない。

hooks は Plugin 形式で提供し、tvine が Claude Code 起動時に `--plugin-dir` で渡す。
ユーザーの既存 hooks 設定には影響しない（Plugin hooks は加算的にマージされる）。

### Plugin 構成

```tree
~/.tvine/plugin/
├── .claude-plugin/
│   └── plugin.json
├── hooks/
│   └── hooks.json
└── scripts/
    └── notify.sh
```

### Claude Code 起動コマンド

```bash
# 初回
claude --session-id <uuid> --plugin-dir ~/.tvine/plugin
# 再接続
claude --resume <uuid> --plugin-dir ~/.tvine/plugin
```

- `--plugin-dir` はその起動限りで有効。ユーザーの環境に永続的な変更を加えない
- tvine を使わずに直接 `claude` を起動すれば Plugin は読み込まれない

### hook スクリプトへの情報伝達

tvine が Claude Code 起動時に以下の環境変数を設定する。hook スクリプトはこれらを使って書き込み先を組み立てる。

| 環境変数 | 値 |
| --- | --- |
| `TVINE_PROJECT_DIR` | `~/.tvine/projects/<project-id>` |
| `TVINE_SESSION_ID` | セッションの UUID |
| `TVINE_SOCKET_PATH` | Unix socket のパス |

### 状態遷移

```txt
SessionStart → Idle
UserPromptSubmit → Busy
PreToolUse → Busy
  ├── PermissionRequest → Waiting（許可待ち）
  ├── PostToolUse → Busy（次のツールへ）
  └── Stop → Idle（応答完了）
```

### 使用する hooks イベント

| ステータス | プライマリ（即時） | セカンダリ（補強） |
| --- | --- | --- |
| Busy | `PreToolUse` / `PostToolUse` / `UserPromptSubmit` | — |
| Waiting | `PermissionRequest` | `Notification(permission_prompt)` / `Notification(elicitation_dialog)` |
| Idle | `Stop` | `Notification(idle_prompt)` ※60秒遅延 |

### 既知の制約

- `AskUserQuestion` 型の質問待ちは `PermissionRequest` では捉えられない。`Notification(elicitation_dialog)` で対応できる可能性があるが未確定
- `Notification(idle_prompt)` は 60 秒遅延があるため、即時の Idle 検出には `Stop` を使う
- `Notification(permission_prompt)` にも 1-2 秒の遅延報告あり。`PermissionRequest` の方が即時性が高い

## 通知経路

hook スクリプトは2つの経路でステータスを伝える：

1. **Unix socket**（リアルタイム）— tvine が起動中ならフロントエンドに即反映
2. **ファイル**（永続化）— `~/.tvine/projects/<project-id>/sessions/<session-id>/status.json` に毎回書き込む

```text
Claude Code → hook 発火 → シェルスクリプト → Unix socket → tvine(Rust) → Tauri イベント → フロントエンド
                                            └→ ファイル書き込み（~/.tvine/projects/<project-id>/sessions/<session-id>/status.json）
```

1. Claude Code が hook イベントを発火
2. Plugin のシェルスクリプトが実行される（async）
3. スクリプトがステータスをファイルに書き込む（常に成功）
4. スクリプトが Unix socket 経由で tvine の Rust バックエンドに JSON を送信（tvine が落ちていれば失敗するだけ）
5. Rust が Tauri イベントとしてフロントエンドに通知
6. フロントエンドがセッション一覧のステータスを更新

## tvine 復帰時のステータス復元

tvine が落ちて再起動した場合、Claude Code プロセスの生死によって挙動が変わる（要検証）：

- **Claude Code が生き残っている場合**: `~/.tvine/projects/<project-id>/sessions/<session-id>/status.json` から最後のステータスを読む。hook スクリプトは tvine の生死に関係なくファイルを更新し続けているため、正確な状態が得られる
- **Claude Code も死んでいる場合**: 全セッションを Idle として扱う。ユーザーがセッションを選択した時に `--resume` で再接続する

※ tvine が落ちた時に Claude Code のプロセスが死ぬかどうかは PTY の実装に依存する。実装時に検証する

## 表示

セッション一覧のカードに色付き丸で表示する。

| ステータス | 色 | 意味 |
| --- | --- | --- |
| Busy | 🟢 緑 | Claude Code が作業している |
| Waiting | 🟡 黄 | ユーザーの確認・承認を待っている |
| Idle | ⚫ グレー | 新しい入力を受け付けられる状態 |
