# tvine - Worktree × AI 並列開発ツール 設計メモ

## 解決すること

1. ブランチを先に選ぶ → Claude Codeセッション開始の順序
2. どのworktreeが何をやっているかわかる一覧表示
3. 日本語IME対応（composition eventの確定Enterと送信Enterの区別）
4. 差分が見やすい
5. 複数worktreeでのDocker環境管理

## 技術スタック

- Tauri（Rust + TypeScript）
- ターミナル埋め込み：xterm.js
- エディタ：Monaco Editor（詳細モードのFileタブ）
- IME対応はWebView側のCompositionEventで処理

## UI方針

- ネイティブアプリ（Web/ブラウザはNG。Chromeのタブが増えて体験が落ちるため）
- 2つのモード：**通常モード**と**詳細モード**
- 通常モード：セッション間を行き来しながらチャット
- 詳細モード：1つのセッションに集中して差分確認・ファイル閲覧

---

## 通常モード（3カラム）

```
┌──────────┬──────────────────┬──────────┬──┐
│ Sessions │  Chat            │ Changes  │⌨│
│          │                  │┄┄┄┄┄┄┄┄┄│  │
│ ● feat…🟢│                  │ unified  │  │
│ ● fix… 🟡│                  │ diff     │  │
│ ● ref… ⚫│                  │          │  │
│          ├──────────────────┤          │  │
│          │ [📂] [⌨] │入力  │          │  │
└──────────┴──────────────────┴──────────┴──┘
```

### Sessions（左カラム、260px）

- worktree一覧
- 各カード：
  - ヘッダー行：ℹ️（情報モーダル、常に表示）+ ブランチ名 + ステータス
  - base: ベースブランチ名
  - タイトル（Claude Codeセッションから自動取得、見切れあり）
  - memo（表示のみ、見切れあり）
  - フッター左：🗑 削除アイコン → 確認モーダル
  - フッター右：📂 詳細 → 詳細モードへ遷移
- シングルクリック：セッション選択（ハイライト切り替え、右のChatが切り替わる）
- ダブルクリック：詳細モードへ遷移
- スロット使用数（2/6）表示
- [+ New] ボタン → 新規作成モーダル

### Chat（中央カラム、flex）

- Claude Codeのチャット履歴表示
- 入力バー（常に下部に表示）
  - 📂 Changesトグルボタン
  - ⌨ Terminalトグルボタン
  - テキスト入力
  - 送信ボタン
- 💬アイコンは通常モードでは非表示（詳細モード時のみ）

### Changes（右カラム、360px、トグル）

- 上1/3：変更ファイル一覧（スクロール可）
  - M/A/Dバッジ付き
  - ファイルをクリックで下にdiff表示
- 下2/3：unified diff表示
  - `+`/`-`が上下に並ぶ形式（狭いカラムでも収まる）
  - hunk header、行番号、色分け
- ヘッダー左の ✕ で閉じる
- 閉じた状態：40px幅のアイコンバー（📂 + 縦書き"Changes"）が残る
  - アイコンバーをクリックで再び開く

### Terminal（右端、トグル）

- Changesと同様の方式
- 閉じた状態：40px幅のアイコンバー（⌨ + 縦書き"Terminal"）
- 開くと360px幅
- ヘッダー左の ✕ で閉じる
- JetBrains Monoフォント

---

## 詳細モード

「📂 詳細 →」クリックで遷移。← 戻る で通常モードに復帰。

```
┌──────────┬──────────────────────────┬──┐
│ Changes  │ [💬 Chat] [Diff] [File] │⌨│
│ Files    │                          │  │
│          │  サイドバイサイドdiff     │  │
│ M login… │  or File表示             │  │
│ A test…  │  or Chat                 │  │
│ 📁 src   │                          │  │
│          ├──────────────────────────│  │
│          │ [💬] [⌨] │入力          │  │
└──────────┴──────────────────────────┴──┘
```

### 左サイドバー

- ← 戻る（通常モードに復帰）
- 選択中のブランチ名 + ステータス + 🗑削除
- base: ベースブランチ表示
- memo表示 + ✏️編集ボタン（クリックで編集モードに切り替え）
- Changes (N)：変更ファイル一覧 → クリックでDiff表示
- Files：ファイルツリー → クリックでFile表示

### 中央エリア

- タブ切り替え：💬 Chat / Diff / File
- **Chat**：チャット履歴
- **Diff**：サイドバイサイド（2カラム、左=変更前、右=変更後、行番号、ハイライト）
- **File**：Monaco Editor（VSCodeのコア）による編集可能なファイル表示
  - シンタックスハイライト、補完
  - 自動保存：入力停止後1秒で保存（debounce）、タブ切替時・モード切替時にも保存
  - 未保存時はファイル名横に●表示
  - 保存は実ファイルへの直接書き込み（worktreeディレクトリ）
  - Claude Codeがgit diffで変更を認識するため、特別な差分受け渡しは不要
  - 想定フロー：自分で修正 → チャットで「ここ直したから残りの依存部分も修正して」と指示
  - 詳細モード遷移時に遅延読み込み（通常モードの軽さに影響しない）
- Diff/File表示時、タブ右にレイアウト切り替え（⬜全画面 / ⬒上下分割）
  - 上下分割時：上にDiff/File、下にChat
  - 上パネルのファイル名左に ✕ → 閉じてChat全画面に戻る

### ファイルドロップ

- 中央エリアにファイルをドラッグ → ドロップゾーン表示
- 全画面表示 or 上半分に表示（下にChat）を選択可

### 入力バー

- 💬 チャットに戻る（詳細モード時のみ表示）
- ⌨ ターミナルトグル
- テキスト入力 + 送信ボタン

---

## memo編集

- **通常モード**：カードヘッダーのℹ️（常に表示）→ 情報モーダルで編集
  - モーダルにはカードで見切れた情報もフル表示（タスク全文など）
  - memoフィールドを編集して保存
- **詳細モード**：ブランチ名の下にmemo表示。✏️ボタンで編集モードに切り替え。

---

## モーダル

### セッション情報モーダル（ℹ️）

- ブランチ名（フル表示）
- ベースブランチ
- ステータス
- タスク（フル表示、見切れなし）
- memo（編集可能）
- アクション：キャンセル / 保存

### 新規作成モーダル（+ New）

- ベースブランチ：セレクト（main / develop / staging等）
- ブランチ名：テキスト入力（feature/xxx）
- タスク：テキストエリア（Claude Codeへの最初の指示）
- memo：テキスト入力（任意）
- アクション：キャンセル / 作成する

### 削除確認モーダル（🗑）

- ブランチ名表示
- base ブランチ表示
- 実行される処理の説明：
  - docker compose down（コンテナ停止・削除）
  - git worktree remove
  - スロットの解放
- アクション：キャンセル / 削除する
- 通常モード・詳細モードの両方から実行可能

---

## Docker方針【スロット方式】

### 2つの問題

このツールは2つの独立した問題を1つのツールで解決する：

1. **worktreeによるClaude Codeの最適化**
2. **worktreeによるDocker環境の最適化**

### 基本方針

- 既存の `docker-compose.yml` には一切手を加えない
- スロット方式：最大6個の同時実行枠
- worktreeは使い捨て（タスク完了で削除）
- worktreeのディレクトリで普通に `docker compose up` すれば動く

### スロット方式の設計

- 6スロット分のポートセットを事前確保
- worktree作成時にスロットを割り当て
- ツールがworktreeディレクトリに以下を自動生成：
  - `.env`（COMPOSE_PROJECT_NAME、COMPOSE_FILE、ポート番号）
  - `docker-compose.worktree.yml`（ポート上書き）
- ユーザーは `cd worktree && docker compose up` するだけ
- worktree削除時にスロット解放

### サービス分離方針

- named volumesを持つサービス（DB, Redis等） → 共有
- ソースコードをマウントしているサービス（web, worker等） → worktreeごとに分離
- ツールが `docker-compose.yml` をパースして自動判別

### 未解決【要議論】

- 既存の `.env` や `override.yml` との共存・マージ
- DB接続先がハードコードされている場合の対処
- Docker を使わないプロジェクトへの対応
- 自動判別ロジックの汎用性検証

---

## Phase 分け

### Phase 1（1〜2週間）

- Tauriの骨組み
- 通常モード：Sessions一覧 + Chat + Changes/Terminalトグル
- セッション選択 → Claude Codeプロセス起動
- ターミナル埋め込み（xterm.js）
- IME対応

### Phase 2（+1〜2週間）

- 詳細モード：Chat/Diff/Fileタブ切り替え
- Monaco Editorの統合（Fileタブ、自動保存）
- サイドバイサイドdiff、unified diff
- ファイルツリー、ファイル表示
- 上下分割レイアウト、ファイルドロップ
- 新規作成・削除モーダル

### Phase 3（+1週間〜要議論）

- Docker環境の自動管理（スロット方式）

### worktree削除時のクリーンアップ

1. `docker compose down`（コンテナ＋ネットワーク削除）
2. ボリューム削除（必要に応じて）
3. `git worktree remove`
4. スロット解放

---

## 権限管理

- `allowedDirectories` でworktreeごとにClaude Codeのアクセス範囲を自動制限
- Docker（Phase 3）ではOS/カーネルレベルで分離
